services:
  # DynamoDB Local Database
  dynamodb-hackathon:
    image: amazon/dynamodb-local:2.5.2
    container_name: dynamodb-local-hackathon
    user: "0:0"
    command: ["-jar", "DynamoDBLocal.jar", "-sharedDb", "-dbPath", "/home/dynamodblocal/data"]
    ports:
      - "8000:8000"
    volumes:
      - dynamodb_data-hackathon:/home/dynamodblocal/data
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/8000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - lea-network

  # DynamoDB Admin UI
  dynamodb-admin-hackathon:
    image: aaronshaf/dynamodb-admin
    container_name: dynamodb-admin-hackathon
    environment:
      - DYNAMO_ENDPOINT=http://dynamodb-hackathon:8000
      - AWS_REGION=${AWS_REGION:-ap-southeast-1}
      - AWS_ACCESS_KEY_ID=dummy
      - AWS_SECRET_ACCESS_KEY=dummy
    depends_on:
      dynamodb-hackathon:
        condition: service_healthy
    ports:
      - "8010:8001"
    restart: unless-stopped
    networks:
      - lea-network

  # Database Initialization
  dynamodb-init-hackathon:
    build:
      context: .
      dockerfile: scripts/Dockerfile.init
    container_name: dynamodb-init-hackathon
    environment:
      - AWS_REGION=${AWS_REGION:-ap-southeast-1}
      - DDB_ENDPOINT=http://dynamodb-hackathon:8000
      - DYNAMODB_PAYMENTS_TABLE=${DYNAMODB_PAYMENTS_TABLE:-lea-payments-local}
    depends_on:
      dynamodb-hackathon:
        condition: service_healthy
    restart: "no"
    networks:
      - lea-network

  # Main Backend API Server
  backend-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: lea-backend-api
    environment:
      - NODE_ENV=development
      - PORT=3001
      - AWS_REGION=${AWS_REGION:-ap-southeast-1}
      - DDB_ENDPOINT=http://dynamodb-hackathon:8000
      - DYNAMODB_PAYMENTS_TABLE=${DYNAMODB_PAYMENTS_TABLE:-lea-payments-local}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}
    depends_on:
      dynamodb-hackathon:
        condition: service_healthy
      dynamodb-init-hackathon:
        condition: service_completed_successfully
    ports:
      - "3001:3001"
    volumes:
      - ./backend:/app
      - /app/node_modules
    restart: unless-stopped
    networks:
      - lea-network

  # Stripe Webhook Handler
  stripe-webhook-hackathon:
    build:
      context: .
      dockerfile: webhook/Dockerfile
    container_name: stripe-webhook-hackathon
    environment:
      - AWS_REGION=${AWS_REGION:-ap-southeast-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-dummy}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-dummy}
      - DYNAMODB_PAYMENTS_TABLE=${DYNAMODB_PAYMENTS_TABLE:-lea-payments-local}
      - DDB_ENDPOINT=http://dynamodb-hackathon:8000
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - PORT=8085
    depends_on:
      dynamodb-hackathon:
        condition: service_healthy
      dynamodb-init-hackathon:
        condition: service_completed_successfully
    ports:
      - "8086:8085"
    healthcheck:
      test: ["CMD", "sh", "-lc", "curl -sf --max-time 3 http://localhost:8085/health > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - lea-network

  # Payment Success/Cancel Pages
  payment-pages-hackathon:
    build:
      context: .
      dockerfile: payment_pages/Dockerfile
    container_name: payment-pages-hackathon
    environment:
      - PORT=8085
    ports:
      - "8085:8085"
    healthcheck:
      test: ["CMD", "sh", "-lc", "curl -sf --max-time 3 http://localhost:8085/health > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - lea-network

  # Frontend React App (Optional)
  frontend-app:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: lea-frontend-app
    environment:
      - REACT_APP_API_URL=http://localhost:3001
      - REACT_APP_PAYMENT_WEBHOOK_URL=http://localhost:8086
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend-api
    restart: unless-stopped
    networks:
      - lea-network

volumes:
  dynamodb_data-hackathon:

networks:
  lea-network:
    driver: bridge